---
layout: post
title: Modifying Code Generation Templates for MvcContrib Grid
date: '2010-06-01T12:58:00.005-04:00'
author: Michael Callaghan
tags: 
modified_time: '2010-06-02T09:48:07.391-04:00'
thumbnail: http://4.bp.blogspot.com/_r716ib2ttTs/TAU3L6TxH3I/AAAAAAAAAEE/pOLGyPKS-4k/s72-c/New+Picture.bmp
blogger_id: tag:blogger.com,1999:blog-2890709913211146020.post-5191798125189292216
blogger_orig_url: http://www.walkingriver.com/2010/06/modifying-code-generation-templates-for.html
---

Visual Studio 2010 in general, and MVC 2 in particular, bring the concept of code generation templates into the realm of first-class objects. Well, maybe it's not that good. However, MVC definitely makes tremendous use of the code generation template system, called Text Transformation Template Toolkit (or T4 for short). A fantastic introduction to T4 editing can be found in the January 2010 issue of <i>MSDN Magazine</i>, titled "<a href="http://msdn.microsoft.com/en-us/magazine/ee291528.aspx">Text Template Transformation Toolkit and ASP.NET MVC</a>." That article covers the basics of editing T4 templates, so I won't bother repeating the same information. Instead, I'll describe the template I created for our team's latest project.<br /><br />Before I get to the template itself, I need to describe the tools we're using, how to install them, and a little background on why we decided to do what we're doing.<br /><br /><h2>The tools</h2><h3>MvcContrib Grid</h3>Early on, we did what most teams do. We used the tools provided. For creating a list of strongly-typed objects (users, items, etc.), we simply chose the default "List" template that ships with MVC 2. Sure, it made our jobs easy, but I wasn't a huge fan of the HTML it generated. <br /><br />Essentially, the List template uses reflection to look at the public properties of your model, and creates a simple HTML table using the raw property names as column headers. It also adds links to each row for "edit," "details," and "delete" actions. After the table's close tag, a handy link is provided to your "add" action.<br /><br />About a month or so into our project, we discovered the <a href="http://mvccontrib.codeplex.com/wikipage?title=Grid">MvcContrib project and its Grid helper</a>. After experimenting with it for a few days, we decided that we preferred it to the default List view code, and that would use it exclusively for generating all of our List views. <br /><br />At its simplest, given a strongly-typed Model, it will generate a grid very similar to what the default template gives you with a single line of code:<br /><br /><pre class="brush: csharp">&lt;%:Html.Grid(Model).AutoGenerateColumns()%&gt;</pre><br />For us, the concise and simple View made it a no-brainer for us. From that time forward, we simply created an empty strongly-typed View and then added the line above, any additional ActionLinks we needed, and we were done. <br /><br />I'm nothing if not lazy, so I wanted to see what it would take to avoid even typing that one line above! I remembered reading the T4 article mentioned above, and thought I'd spend some time trying to make a new template that would do the work for me. Of course, if something is worth doing, then someone has probably already done it. <br /><br />In this case, it was done more than a year ago, by a gentleman named Shiju Varghese. In his post titled, "<a href="http://weblogs.asp.net/shijuvarghese/archive/2009/03/04/asp-net-mvc-tip-add-a-new-t4-template-for-making-mvccontrib-grid-helper-component.aspx">Add a new T4 template for making MVCContrib Grid Helper Component</a>," he describes how to alter the default List template into a new one that uses the MvcContrib grid. Perfect! I decided to start there.<br /><br /><h3>tangible T4 Editor</h3>So now I needed a way to edit the .tt files. Sure, I could open them as raw text file, but where's the fun in that? If you're running Visual Studio 2008 or 2010, there is a great free add-on called the <a href="http://visualstudiogallery.msdn.microsoft.com/en-us/60297607-5fd4-4da4-97e1-3715e90c1a23">tangible T4 Editor</a>. Essentially, it provides syntax coloring and IntelliSense to Visual Studio while editing the .tt files. So I visited the <a href="http://visualstudiogallery.msdn.microsoft.com/en-us/60297607-5fd4-4da4-97e1-3715e90c1a23">download site</a> and installed the add-on.<br /><br /><h2>Editing the List Template</h2>Once the template editor was installed, I had to find the existing List template and modify it. This turned out to be pretty straightforward. In my case, the MVC view templates can be found at C:\Program Files\Microsoft Visual Studio 10.0\Common7\IDE\ItemTemplates\CSharp\Web\MVC 2\CodeTemplates\AddView. On a 64-bit machine, check C:\Program Files (x86)\Microsoft Visual Studio 10.0\Common7\IDE\ItemTemplates\CSharp\Web\MVC 2\CodeTemplates\AddView. The template that I wanted to edit is "List.tt," which I copied into the same directory and immediately renamed it to "Grid.tt" to differentiate it from the original.<br /><br />The really cool thing about this is that Visual Studio automatically recognizes it displays it in the Add View dialog.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/_r716ib2ttTs/TAU3L6TxH3I/AAAAAAAAAEE/pOLGyPKS-4k/s1600/New+Picture.bmp" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/_r716ib2ttTs/TAU3L6TxH3I/AAAAAAAAAEE/pOLGyPKS-4k/s320/New+Picture.bmp" /></a></div><br />One question you may be asking is, "If you already have the template, why do you still want to edit it?" One problem with both the default List template and Shiju's grid template is that neither honors the DataAnnotations on your view model. Specifically, our project requires us to support multiple languages. Simply iterating over the model's properties and blindly displaying the property name in the column header is not an option for us. We need to ensure that the column headers are localized. Furthermore, there may be columns we don't want to display at all. Fortunately, later versions of the MvcContrib Grid make this very simple.<br /><br />So starting with Shiju's code as an example, I made my template look like this.<br /><br /><pre class="brush: csharp">// See if the model has primary keys and generate appropriate ActionLinks for Edit and Delete.<br />List<string> primaryKeys = GetEntityKeyProperties(mvcHost.ViewDataType);<br />String editAction = String.Empty;<br />String deleteAction = String.Empty;<br /><br />if(primaryKeys.Count &gt; 0) {<br /> editAction = String.Format("Html.ActionLink(\"Edit\", \"Edit\", new {{ "{{" }} id=x.{0} }})", primaryKeys[0]);<br /> deleteAction = String.Format("Html.ActionLink(\"Delete\", \"Delete\", new {{ "{{" }} id=x.{0} }})", primaryKeys[0]);<br />} else {<br /> editAction = "Html.ActionLink(\"Edit\", \"Edit\", new { /* id=x.PrimaryKey */ })";<br /> deleteAction = "Html.ActionLink(\"Delete\", \"Delete\", new { /* id=x.PrimaryKey */ })";<br />}<br /><br />if(!String.IsNullOrEmpty(mvcViewDataTypeGenericString)) <br />{<br /> Dictionary<string, string=""> properties = new Dictionary<string, string="">();<br /> FilterProperties(mvcHost.ViewDataType, properties);<br />#&gt;<br /> &lt;%&lt;#=nugget#&gt; Html.Grid&lt; &lt;#=mvcHost.ViewDataType#&gt; &gt;(Model).AutoGenerateColumns()<br /> .Columns(column=&gt;<br />  {<br />  column.For(x=&gt;&lt;#=editAction#&gt;).Encode(false);<br />  column.For(x=&gt;&lt;#=deleteAction#&gt;).Encode(false);<br />  })<br />  .Empty("There are no records.")<br />  %&gt;<br />  &lt;#}#&gt;</string,></string,></string></pre>(Download the <a href="http://www.rsfares.com/misc/Grid.tt">entire TT file here</a>)<br /><br />Notice that I'm using AutoGenerateColumns(), and then adding the additional columns afterward. The beauty of this approach is that AutoGenerateColumns() honors the various attributes in the System.ComponentModel.DataAnnotations namespace. All of the display decisions (order, template, localized header name) can be handled in a declarative manner in the view model. For example, [DisplayName] and [ScaffoldColumn] on your view model's properties will automatically be reflected in the View. Likewise, any changes to your view model will be handled automatically when your project is rebuilt.<br /><br />There is a known issue with using [DisplayName] that I won't go into here, except to say that if you're using MVC 2 with ASP.NET 4, you have to subclass the DisplayNameAttribute to get it to work. This is an issue with .NET, and not with the MvcGrid, and does not affect the use of the template.<br /><br /><h2>Additional Enhancements</h2>You may have noticed that I didn't localize the edit and delete ActionLinks, nor did I bother with an add ActionLink. I am still trying to come up with a generic way to handle that in a way that's still localizable. One thought I had is to access a properties on the view model called "AddTitle," "EditTitle," and "DeleteTitle." These could be read-only properties on a view model base class that simply returns the appropriate localized resource. I may end up taking that approach, but it still means infusing my template with domain knowledge. Maybe that's not a horrible thing. I'd love to hear comments from others who have run into the same problem.